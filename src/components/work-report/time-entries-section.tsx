"use client"; import { useFormContext } from 'react'; import { Button } from '@/components/ui/button'; import { Input } from '@/components/ui/input'; import { FormControl, FormField, FormItem, FormLabel, } from '@/components/ui/form'; import { PlusCircle } from 'lucide-react'; import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover'; import { Calendar } from '@/components/ui/calendar'; import { cn } from '@/lib/utils'; import { format } from 'date-fns'; import { WorkReportFormValues } from '@/components/work-report-form'; interface TimeEntryRowProps { index: number; onRemove: () => void; canRemove: boolean; } const timeOptions = [ '08:00-12:00', '12:00-14:00', '14:00-18:00', '08:00-18:00', ]; export const TimeEntriesSection = () => { const { control } = useFormContext<WorkReportFormValues>(); const { fields, append, remove } = useFieldArray({ control, name: "time_entries", }); const timeEntries = control.getValues('time_entries'); const totalHours = timeEntries?.reduce((sum, entry) => sum + (entry.total_hours || 0), 0) || 0; // Calcolo automatico ore useEffect(() => { fields.forEach((_, index) => { const start1 = control.getValues(`time_entries.${index}.time_slot_1_start`); const end1 = control.getValues(`time_entries.${index}.time_slot_1_end`); const start2 = control.getValues(`time_entries.${index}.time_slot_2_start`); const end2 = control.getValues(`time_entries.${index}.time_slot_2_end`); const calculated = calculateHours(start1, end1, start2, end2); control.setValue(`time_entries.${index}.total_hours`, calculated, { shouldValidate: false }); }); }, [timeEntries, fields, control]); const handleAddEntry = () => { append({ date: new Date(), technician: '', time_slot_1_start: '', time_slot_1_end: '', time_slot_2_start: '', time_slot_2_end: '', total_hours: 0, }); }; return ( <div className="space-y-4 rounded-lg border p-6 bg-white dark:bg-gray-900"> <div> <h3 className="text-lg font-semibold text-gray-900 dark:text-gray-100"> Ore di lavoro (uomo/ora) </h3> <p className="text-sm text-gray-600 dark:text-gray-400 mt-1"> Aggiungi una riga per tecnico e per giorno. Le ore si calcolano da Inizio/Fine su 1 o 2 fasce (es. pausa pranzo). </p> </div> <div className="space-y-4"> {fields.map((field, index) => ( <TimeEntryRow key={field.id} index={index} onRemove={() => remove(index)} canRemove={fields.length > 1} /> ))} </div> <Button type="button" variant="outline" onClick={handleAddEntry} className="flex items-center gap-2" > <PlusCircle size={16} /> + Riga ore </Button> <div className="flex justify-end items-center gap-6 pt-4"> <span className="text-lg font-semibold text-gray-900 dark:text-gray-100"> Totale ore: {totalHours.toFixed(2)} </span> <FormField control={control} name="kilometers" render={({ field }) => ( <FormItem className="flex items-center gap-2"> <FormLabel className="text-gray-700 dark:text-gray-300">Km (opz.)</FormLabel> <FormControl> <Input type="number" step="1" placeholder="0" {...field} /> </FormControl> <FormMessage /> </FormItem> )} /> </div> </div> ); };